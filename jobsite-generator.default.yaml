
# basic information for generating and executing this definition
SenzaInfo:
  StackName: jobsite-generator
  Parameters:
    - ImageVersion:
        Description: "Docker image version of jobsite-generator."

# a list of senza components to apply to the definition
SenzaComponents:

  # this basic configuration is required for the other components
  - Configuration:
      Type: Senza::StupsAutoConfiguration # auto-detect network setup

  # will create a launch configuration and auto scaling group with scaling triggers
  - AppServer:
      Type: Senza::TaupageAutoScalingGroup
      InstanceType: t2.micro
      SecurityGroups:
        - app-jobsite-generator
      IamRoles:
        - app-jobsite-generator
      ElasticLoadBalancer: AppLoadBalancer
      TaupageConfig:
        runtime: Docker
        source: "pierone.stups.zalan.do/tfox/jobsite-generator:{{Arguments.ImageVersion}}"
        environment:
          TFOX_ENV: qa
          S3BUCKET_QA: "tech.workplace.zalan.do"
          S3REGION_QA: "eu-central-1"
          JOBSITE_DEPLOY_SCHEDULED: true
          PRISMIC_SECRET: "<TODO-FILL-IN>"
          PRISMIC_APIURL: "<TODO-FILL-IN>"
          GATRACKINGID_QA: "UA-5362052-33"
          # workaround for https://github.com/tkellen/js-v8flags/issues/17
          HOME: "/opt/tfox/static-site-gen/build"
        ports:
          8080: 8080
        # the following fixes /opt/zalando/init.sh getting stuck forever in:
        # "Waiting for berry to download OAuth credentials to /meta/credentials/user.json"
        token_service_url: ""

  # creates an ELB entry and Route53 domains to this ELB
  - AppLoadBalancer:
      Type: Senza::WeightedDnsElasticLoadBalancer
      HTTPPort: 8080
      HealthCheckPath: /healthcheck
      SecurityGroups:
        - app-jobsite-generator-lb
